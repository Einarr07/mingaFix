# Etapa 1: Build con Gradle Wrapper y JDK 21
FROM gradle:8.14.3-jdk21 AS build
WORKDIR /app

# Copiar solo archivos de build para cache de dependencias
COPY build.gradle settings.gradle gradlew ./
COPY gradle ./gradle

# Instalar dependencias
RUN ./gradlew build -x test --no-daemon || true

# Copiar el resto del proyecto
COPY . .

# Construir el jar usando Gradle Wrapper
RUN ./gradlew bootJar --no-daemon

# Etapa 2: Runtime con JDK 21
FROM eclipse-temurin:21-jdk
WORKDIR /app

# Copiar el jar generado
COPY --from=build /app/build/libs/*.jar mingaFix.jar

# Puerto expuesto
EXPOSE 8080

# Ejecutar Spring Boot con perfil dev
ENTRYPOINT ["java", "-Dspring.profiles.active=dev", "-jar", "mingaFix.jar"]
